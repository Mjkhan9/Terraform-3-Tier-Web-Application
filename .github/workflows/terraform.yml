name: Terraform CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OIDC PERMISSIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# These permissions enable password-less AWS authentication using OIDC.
# No AWS Access Keys needed - GitHub Actions assumes an IAM role directly.
# This is the modern, secure approach recommended by AWS and GitHub.
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required for checkout
  pull-requests: write  # Required for PR comments

env:
  TF_VERSION: "1.6.0"
  AWS_REGION: "us-east-1"
  TF_VAR_db_password: "placeholder-for-ci"
  # OIDC Role ARN - set this after creating the OIDC module
  # AWS_ROLE_ARN: "arn:aws:iam::ACCOUNT_ID:role/3-tier-web-app-github-actions-role"

jobs:
  # Job 1: Format Check
  format:
    name: ğŸ“ Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Format Status
        run: |
          if terraform fmt -check -recursive; then
            echo "âœ… All Terraform files are properly formatted"
          else
            echo "âš ï¸ Some files need formatting. Run 'terraform fmt -recursive' locally."
          fi

  # Job 2: Validate
  validate:
    name: âœ… Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

  # Job 3: Security Scan with tfsec
  security:
    name: ğŸ”’ Security Scan (tfsec)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          format: lovely

      - name: Security Summary
        run: echo "ğŸ”’ Security scan complete. Review any findings above."

  # Job 4: Checkov Security Scan
  checkov:
    name: ğŸ›¡ï¸ Security Scan (Checkov)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: cli

  # Job 5: Terraform Plan (on PR)
  plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: [format, validate]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # OIDC AUTHENTICATION (Uncomment after setting up OIDC module)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # - name: Configure AWS credentials via OIDC
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ env.AWS_ROLE_ARN }}
      #     aws-region: ${{ env.AWS_REGION }}
      #     role-session-name: GitHubActions-TerraformPlan

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false
        continue-on-error: true

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const output = `### Terraform Plan Results ğŸ“‹
            
            #### Format Check ğŸ–Œï¸: \`${{ needs.format.result }}\`
            #### Validation ğŸ¤–: \`${{ needs.validate.result }}\`
            #### Plan ğŸ“–: \`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # Job 6: Cost Estimation
  cost:
    name: ğŸ’° Cost Estimation
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

      - name: Generate Cost Estimate
        run: |
          if command -v infracost &> /dev/null; then
            infracost breakdown --path . --format table
          else
            echo "ğŸ’° Infracost not configured. Add INFRACOST_API_KEY secret to enable cost estimation."
            echo ""
            echo "Estimated monthly cost (manual calculation):"
            echo "  - NAT Gateways (2x): ~\$64/month"
            echo "  - ALB: ~\$16/month"
            echo "  - EC2 t3.micro (2x): ~\$15/month"
            echo "  - RDS db.t3.micro: ~\$15/month"
            echo "  - S3 + Data Transfer: ~\$5/month"
            echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "  Total Estimate: ~\$115/month (outside Free Tier)"
          fi
        continue-on-error: true

  # Job 7: Documentation Check
  docs:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ -f "README.md" ]; then
            echo "âœ… README.md found"
            echo "ğŸ“Š Word count: $(wc -w < README.md) words"
          else
            echo "âŒ README.md not found"
            exit 1
          fi

      - name: Check for architecture docs
        run: |
          if [ -f "ARCHITECTURE.md" ]; then
            echo "âœ… ARCHITECTURE.md found"
          fi
          if [ -f "DEPLOYMENT.md" ]; then
            echo "âœ… DEPLOYMENT.md found"
          fi

  # Job 8: Generate Plan Artifact
  plan-artifact:
    name: ğŸ“‹ Generate Plan Artifact
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Generate Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false \
            -var="db_password=placeholder-for-ci" \
            -out=tfplan 2>&1 | tee plan-output.txt

      - name: Generate Plan Summary
        run: |
          echo "# Terraform Plan Output" > plan-summary.md
          echo "" >> plan-summary.md
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> plan-summary.md
          echo "Commit: ${{ github.sha }}" >> plan-summary.md
          echo "" >> plan-summary.md
          echo '```' >> plan-summary.md
          terraform show -no-color tfplan >> plan-summary.md
          echo '```' >> plan-summary.md

      - name: Save Plan Output
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.sha }}
          path: |
            plan-output.txt
            plan-summary.md
          retention-days: 90

  # Job 9: Drift Detection (scheduled)
  drift-detection:
    name: ğŸ” Drift Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Check for Drift
        id: drift
        run: |
          set +e
          terraform plan -detailed-exitcode -no-color -input=false \
            -var="db_password=placeholder" > drift-report.txt 2>&1
          DRIFT_EXIT=$?
          set -e
          
          if [ $DRIFT_EXIT -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "::warning::Infrastructure drift detected!"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "No drift detected."
          fi

      - name: Save Drift Report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ github.run_id }}
          path: drift-report.txt
          retention-days: 30

  # Summary Job
  summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [format, validate, security, checkov, docs, plan-artifact]
    if: always()
    steps:
      - name: Pipeline Results
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "       ğŸš€ Terraform CI/CD Pipeline Results"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ğŸ“ Format Check:    ${{ needs.format.result }}"
          echo "  âœ… Validation:      ${{ needs.validate.result }}"
          echo "  ğŸ”’ tfsec Scan:      ${{ needs.security.result }}"
          echo "  ğŸ›¡ï¸ Checkov Scan:    ${{ needs.checkov.result }}"
          echo "  ğŸ“š Documentation:   ${{ needs.docs.result }}"
          echo "  ğŸ“‹ Plan Artifact:   ${{ needs.plan-artifact.result }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

