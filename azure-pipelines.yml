trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Validate
    displayName: 'Terraform Validation'
    jobs:
      - job: TerraformValidate
        displayName: 'Format & Validate'
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: 'latest'
            displayName: 'Install Terraform'

          - script: terraform fmt -check -recursive
            displayName: 'Terraform Format Check'

          - script: |
              terraform init -backend=false
              terraform validate
            displayName: 'Terraform Init & Validate'

  - stage: SecurityScan
    displayName: 'Security Scanning'
    dependsOn: Validate
    jobs:
      - job: SecurityChecks
        displayName: 'Run Security Scans'
        steps:
          - script: |
              pip install checkov
              checkov -d . --framework terraform --soft-fail
            displayName: 'Checkov Security Scan'

  - stage: Documentation
    displayName: 'Documentation Check'
    dependsOn: Validate
    jobs:
      - job: DocCheck
        displayName: 'Verify Documentation'
        steps:
          - script: |
              echo "Checking required documentation..."
              for doc in README.md ARCHITECTURE.md DEPLOYMENT.md DESIGN_DECISIONS.md; do
                if [ -f "$doc" ]; then
                  echo "[OK] $doc exists ($(wc -l < $doc) lines)"
                else
                  echo "[MISSING] $doc"
                fi
              done
              echo "Runbooks:"
              ls -la runbooks/ 2>/dev/null || echo "No runbooks directory"
            displayName: 'Documentation Audit'
